apiVersion: v1
kind: ReplicationController
metadata:
  name: monitoring-influxdb-grafana
  namespace: kube-system
  labels:
    k8s-app: monitoring
    version: v1
    kubernetes.io/cluster-service: "true"
spec:
  replicas: 1
  selector:
    k8s-app: monitoring
    version: v1
  template:
    metadata:
      labels:
        k8s-app: monitoring
        version: v1
        kubernetes.io/cluster-service: "true"
    spec:
      containers:
        - image: index.caicloud.io/caicloudgcr/google_containers_heapster_influxdb:v0.5
          name: influxdb
          resources:
            # keep request = limit to keep this container in guaranteed class
            limits:
              cpu: 100m
              memory: 500Mi
            requests:
              cpu: 100m
              memory: 500Mi
          ports:
            - containerPort: 8083
              hostPort: 8083
            - containerPort: 8086
              hostPort: 8086
          volumeMounts:
          - name: influxdb-persistent-storage
            mountPath: /data
        - image: index.caicloud.io/caicloudgcr/google_containers_heapster_grafana:v2.6.0-2
          name: grafana
          resources:
            # keep request = limit to keep this container in guaranteed class
            limits:
              cpu: 100m
              memory: 100Mi
            requests:
              cpu: 100m
              memory: 100Mi
          env:
            # This variable is required to setup templates in Grafana.
            # Note: we change the value from 'monitoring-influxdb' to 'localhost' due to
            # kube-proxy iptables issue: https://github.com/kubernetes/kubernetes/issues/20475
            - name: INFLUXDB_SERVICE_URL
              value: http://localhost:8086
              # The following env variables are required to make Grafana accessible via
              # the kubernetes api-server proxy. On production clusters, we recommend
              # removing these env variables, setup auth for grafana, and expose the grafana
              # service using a LoadBalancer or a public IP.
            - name: GF_AUTH_BASIC_ENABLED
              value: "false"
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "true"
            - name: GF_AUTH_ANONYMOUS_ORG_ROLE
              value: Admin
            - name: GF_SERVER_ROOT_URL
              value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/
          volumeMounts:
          - name: grafana-persistent-storage
            mountPath: /var
        - image: index.caicloud.io/caicloud/monitoring:v0.1.10
          name: monitoring
          imagePullPolicy: Always
          resources:
            # keep request = limit to keep this container in guaranteed class
            limits:
              cpu: 100m
              memory: 150Mi
            requests:
              cpu: 100m
              memory: 150Mi
          env:
            - name: K8S_IP
              value: ""
            - name: K8S_USER
              value: ""
            - name: K8S_PASS
              value: ""
            - name: K8S_INSECURE
              value: ""
            - name: PAGING_URL
              value: {{ pillar['paging_url'] }}
            - name: RUNNING_ENVIRONMENT
              value: {{ pillar['running_enviroment'] }}
            - name: INFLUXDB_URL
              value: http://localhost:8086
            - name: INTERVAL
              value: "30"
            - name: SERVICE_PORT
              value: "6090"
            - name: AUTH_REQUIRED
              value: "Y"
            - name: CLUSTER_ID
              value: {{ pillar['cluster_id'] }}
            - name: UID
              value: {{ pillar['caicloud_uid'] }}
            - name: CLUSTER_TOKEN
              value: {{ pillar['cluster_token'] }}
            - name: CLUSTER_NAME
              value: {{ pillar['cluster_name'] }}
      volumes:
      - name: influxdb-persistent-storage
        emptyDir: {}
      - name: grafana-persistent-storage
        emptyDir: {}

