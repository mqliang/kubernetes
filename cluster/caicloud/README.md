# Caicloud kubernetes

## Overview

Caicloud kubernetes is a customized kubernetes hosted by [caicloud.io](https://caicloud.io). Currently, we support [Anchnet](http://cloud.51idc.com/),
and there is plan to add more cloudproviders. Kubernetes is the building block of caicloud.io, the long term plan is to enrich its ecosystem to enable
enterprise use cases.

## How to do a release

To build release, use script `hack/caicloud/build-tarball.sh`. The script will build caicloud kubernetes binaries, i.e. kubelet, apiserver, etc. It
will also build script release, i.e. kube-up.sh, kube-down.sh etc. To see its full description, run (assuming at kubernetes root directory):
```
./hack/caicloud/build-tarball.sh help
```

E.g. following command will build tarballs tagged with version v1.0.1, and push to Qiniu:
```
./hack/caicloud/build-tarball.sh v1.0.1
```

If running without param, the script will build images with current date/time, this is useful during development. E.g. following command will build
tarballs tagged with something like 2015-09-10-18-15-30.
```
./hack/caicloud/build-tarball.sh
```

## Maintenance

A couple points related to how to maintain caicloud kubernetes.

### Rebase to latest public mainstream

* Find the tag commit to rebase
* Checkout to caicloud master branch
* git rebase --preserve-merges -i $COMMIT_ID
* git push private-upstream master -f

(Use `git config --global rerere.enabled true` to reuse recorded resolustion)

### Things need to be updated after rebasing

* Merge conflict from below changes (we try to keep this as minimal as possible)
* In `hack/caicloud/`, we have scripts fixing GFW issues, make sure it still works with newer kubernetes version
* Run `hack/caicloud/sync-images.sh` to sync all gcr.io images
* Run `hack/caicloud/caicloud-e2e-test.sh`, `hack/build-go.sh`, `hack/test-go.sh`, `hack/test-integration.sh` to build/test new version

### Changes relative to public mainstream

#### New files or directories:

These are brand new folders created to support our cloudprovider:
* cluster/caicloud/
  * Central documentation about caicloud kubernetes
  * Common utilities about kube-up/kube-down of caicloud kubernetes
* cluster/caicloud-anchnet/
  * Scripts used to bring up cluster in anchnet
* cluster/caicloud-baremetal/
  * Scripts used to bring up baremetal cluster
* cluster/kube-add-node.sh
  * A new script used to add a new node into cluster
* hack/caicloud/
  * Various tools for working with caicloud kubernetes
* examples/caicloud/
  * Examples for caicloud, typically about how to use caicloud supported cloudproviders
* pkg/cloudprovider/providers/anchnet/
  * Go package used for anchnet plugin
* pkg/volume/anchnet_pd/
  * Go package used for anchnet persistent volume plugin

#### Changes to individual files

These are individual files we have to change in order to meet our requirements:
* cmd/kubelet/app/plugins.go
  * To load anchnet volume plugin
* pkg/api/types.go, pkg/api/v1/types.go
  * To add `AnchnetPersistentDisk` field in `VolumeSource` structure
  * To add `AnchnetPersistendDisk` field in `PersistentVolumeSource` structure
* pkg/api/validation/validation.go
  * To support validate anchnet persistent disk
* pkg/api/deep_copy_generated.go, pkg/api/v1/conversion_generated.go, pkg/api/v1/deep_copy_generated.go, pkg/expapi/deep_copy_generated.go, pkg/expapi/v1/conversion_generated.go, pkg/expapi/v1/deep_copy_generated.go
  * To support API type changes
  * Auto generated by hack/update-genereated-deep-copies.sh and hack/update-generated-conversions.sh
* test/e2e/util.go
  * To use correct ssh private key & user for e2e test

#### Depedencies:

* Add more dependencies in godeps:
  * Anchnet-go: SDK for anchnet API

## Cluster Upgrade

Cluster upgrade is done using `kube-push.sh` script, which pushes new binaries and configurations to running cluster (The ultimate goal in kubernetes
is self-hosting and do rolling upgrade on cluster components). Note all configurations will be pushed to cluster except certs, credentials, etc. See
respective cloudprovider documentation about how to use the script.
