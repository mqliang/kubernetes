---
- hosts:
    - masters
    - nodes
    - etcd

  become: yes

  tasks:
    - name: Set use_hyperkube to true by default
      set_fact:
        use_hyperkube: true
        networking: weave

    - name: Display system information
      debug: msg="{{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Detecting Operating System
      shell: ls /run/ostree-booted
      ignore_errors: yes
      failed_when: false
      register: ostree_output

    - set_fact:
        is_atomic: "{{ ostree_output.rc == 0 }}"
    - set_fact:
        is_containerized: "{{ is_atomic or containerized | default(false) | bool }}"

    - name: Determine if CoreOS
      raw: "grep '^NAME=' /etc/os-release | sed s'/NAME=//'"
      register: distro
      always_run: yes

    - name: Initialize facts
      set_fact:
        is_coreos: false
        etcd_svc_name: etcd
        bin_dir: "/usr/bin"
        networking: "flannel"
        kube_config_dir: "/etc/kubernetes"

    - name: Determine kubernetes_use_upstart
      set_fact:
        kubernetes_use_upstart: false

    - set_fact:
        kubernetes_use_upstart: true
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_major_version|int < 15

    - name: Set CoreOS facts
      when: "'CoreOS' in distro.stdout"
      set_fact:
        is_coreos: true
        etcd_svc_name: etcd2
        bin_dir: "/opt/bin"
        kube_config_dir: "/etc/kubernetes"

    - name: Remove br0 interface
      shell: ovs-vsctl del-br br0
      changed_when: False
      failed_when: False

    - name: Clear etcd configuration data
      command: etcdctl rm --recursive {{ item }}
      with_items:
        - "/registry"
        - "/calico"
        - "/coreos.com"
        - "/{{ cluster_name }}" #cluster name. default in group_vars/all.yml
      ignore_errors: True
      when: inventory_hostname in groups['etcd']

    - name: Stop services
      service: name={{ item }} state=stopped
      with_items:
        - kubelet
        - kube-addons
        - flanneld
        - calicoctl
        - "{{ etcd_svc_name }}"
        - etcd-server
        - etcd-server-events
      failed_when: false

    - name: Stop services
      service: name={{ item }} state=stopped
      with_items:
        - kube-apiserver
        - kube-controller-manager
        - kube-proxy
        - kube-scheduler
      failed_when: false
      when: not use_hyperkube

    - name: Remove packages
      action: "{{ ansible_pkg_mgr }} name={{ item }} state=absent"
      when: not is_coreos and not is_atomic | bool
      with_items:
        - flannel
        - calicoctl
        - kubernetes-node
        - kubernetes-master
        - kubernetes-client
        - "{{ etcd_svc_name }}"
        - etcd-server
        - etcd-server-events
        - kube-addons
        - atomic-enterprise
        - atomic-enterprise-master
        - atomic-enterprise-node

    - name: CoreOS | Remove bins and systemd files
      file: path={{ item }} state=absent
      when: is_coreos
      with_items:
        - "{{ bin_dir }}/mk-docker-opts.sh"
        - /etc/systemd/system/docker.service.d
        - /etc/systemd/system/etcd2.service.d
        - /etc/systemd/system/kube-apiserver.service.d
        - /etc/systemd/system/kube-scheduler.service.d
        - /etc/systemd/system/kube-controller-manager.service.d/
        - /etc/systemd/system/kubelet.service.d
        - /etc/systemd/system/kube-proxy.service.d

    - name: Remove linux interfaces
      shell: ip link del "{{ item }}"
      changed_when: False
      failed_when: False
      with_items:
        - flannel.1
        - docker0
        - weave

    - shell: systemctl reset-failed
      changed_when: False
      when: not kubernetes_use_upstart

    - shell: find /var/lib/kubelet/pods -type d -exec umount -l {} \; 2>/dev/null || true
      changed_when: False

    - name: Remove remaining files
      file: path={{ item }} state=absent
      with_items:
        - "~{{ ansible_user }}/.kube"
        - /root/.kube
        - "{{ bin_dir }}/kube-apiserver"
        - "{{ bin_dir }}/kube-controller-manager"
        - "{{ bin_dir }}/kubectl"
        - "{{ bin_dir }}/kubelet"
        - "{{ bin_dir }}/kube-proxy"
        - "{{ bin_dir }}/kube-scheduler"
        - "{{ bin_dir }}/flanneld"
        - "{{ bin_dir }}/calicoctl"
        - /run/flannel_docker_opts.env
        - /run/flannel
        - /tmp/flannel-conf.json
        - /opt/flannel-0.5.5 #flannel version can change
        - /opt/cni
        - /etc/cni
        - /etc/kubernetes
        - /etc/systemd/system/kube-addons.service
        - /etc/systemd/system/kube-controller-manager.service
        - /etc/systemd/system/kube-proxy.service
        - /etc/systemd/system/kube-proxy.service.wants
        - /etc/systemd/system/kube-apiserver.service
        - /etc/systemd/system/kube-apiserver.service.wants
        - /etc/systemd/system/kubelet.service
        - /etc/systemd/system/kube-scheduler.service
        - /etc/systemd/system/flanneld.service
        - /etc/systemd/system/flanneld.service.wants
        - /etc/systemd/system/calicoctl.service
        - /etc/systemd/system/multi-user.target.wants/etcd-server.service
        - /etc/systemd/system/multi-user.target.wants/etcd-server-events.service
        - /etc/systemd/system/multi-user.target.wants/flanneld.service
        - /etc/systemd/system/multi-user.target.wants/kubelet.service
        - /etc/systemd/system/multi-user.target.wants/kube-proxy.service
        - /etc/systemd/system/multi-user.target.wants/kube-apiserver.service
        - /etc/systemd/system/multi-user.target.wants/kube-scheduler.service
        - /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service
        - /etc/systemd/system/multi-user.target.wants/kube-addons.service
        - /etc/systemd/system/delay-master-services.target
        - /etc/systemd/system/delay-node-services.target
        - /etc/sysconfig/flanneld
        - /etc/sysconfig/calicoctl
        - "/etc/systemd/system/{{ etcd_svc_name }}.service"
        - /etc/init/kubelet.conf
        - /etc/init/kube-proxy.conf
        - /etc/init/kube-scheduler.conf
        - /etc/init/kube-controller-manager.conf
        - /etc/init/kube-apiserver.conf
        - /etc/init/kube-addons.conf
        - /etc/init/etcd-server.conf
        - /etc/init/etcd-server-events.conf
        - /etc/init/flanneld.conf
        - /etc/init/calicoctl.conf
        - /etc/default/kubelet
        - /etc/default/kube-proxy
        - /etc/default/kube-scheduler
        - /etc/default/kube-controller-manager
        - /etc/default/kube-apiserver
        - /etc/default/etcd-server.conf
        - /etc/default/etcd-server-events.conf
        - /etc/default/flanneld
        - /etc/default/calicoctl
        - /usr/libexec/kubernetes
        - /etc/etcd
        - /etc/tmpfiles.d
        - /usr/local/caicloud-kube
        - /etc/systemd/system/docker.service.d/40-docker-depends-on-flannel.conf
        - "{{ kube_config_dir }}"
        - /var/lib/etcd
        - /var/lib/etcd-events
        - /var/lib/etcd-server
        - /var/lib/etcd-server-events

    - name: Ubuntu | Update docker.conf let docker to be independent of flannel
      lineinfile:
        dest: /etc/init/docker.conf
        regexp: "^start on"
        line: "start on (local-filesystems and net-device-up IFACE!=lo)"
        state: present
      when: kubernetes_use_upstart
      ignore_errors: true

    - lineinfile:
        dest: /etc/init/docker.conf
        regexp: "^stop on"
        line: "stop on runlevel [!2345]"
        state: present
      when: kubernetes_use_upstart
      ignore_errors: true

    - name: Update docker.service
      lineinfile:
        dest: /etc/systemd/system/docker.service
        regexp: "EnvironmentFile=-/run/flannel_docker_opts.env|ExecStartPre="
        state: absent
      when: not kubernetes_use_upstart and networking == "flannel"
      ignore_errors: true

    - lineinfile:
        dest: /etc/systemd/system/docker.service
        regexp: "^ExecStart"
        line: "ExecStart=/usr/bin/docker daemon -H fd://"
        state: present
      when: not kubernetes_use_upstart and networking == "flannel"
      ignore_errors: true

    - shell: systemctl daemon-reload
      changed_when: False
      when: not kubernetes_use_upstart

    - name: Restart docker
      service:
        name: docker
        state: restarted
      ignore_errors: true

    - name: Reload systemd manager configuration
      command: systemctl daemon-reload
      when: not kubernetes_use_upstart

    - name: Finds incomplete or aborted yum transactions on a system and attempts to complete them
      command: yum-complete-transaction --cleanup-only
      failed_when: False
      when: not kubernetes_use_upstart

    - name: CoreOS | unbootstrap python
      raw: rm -r {{ item }}
      when: is_coreos
      with_items:
        - "{{ bin_dir }}/python"
        - "{{ bin_dir }}/pypy"

- hosts:
    - localhost
  tasks:
    - name: Initialize facts
      set_fact:
        bin_dir: "/usr/bin"
        cloud_config_dir: "/var/run"

    - name: Remove remaining files
      file: path={{ item }} state=absent
      with_items:
        - "{{ bin_dir }}/kubectl"
        - "{{ ansible_env.HOME }}/.kube/config"
        - "{{ cloud_config_dir }}/cloud-config"

    - name: Determine use loadbalancer or not | Set default to false
      set_fact:
        use_load_balancer: false

    - name: Use loadbalancer on muti masters with vagrant provider
      set_fact:
        use_load_balancer: true
        load_balancer_vip: "{{ load_balancer_default_vip }}"
      when: host_provider is defined and host_provider == "vagrant" and (groups['masters'] | count) > 1 and (load_balancer_vip is not defined)

    - name: Determine use loadbalancer or not
      set_fact:
        use_load_balancer: true
      when: (groups['masters'] | count) > 1 and ( load_balancer_vip is defined )

    - set_fact:
        first_master_eip:  "{{ hostvars[groups['masters'][0]]['ansible_host'] }}"

    - name: Set kube apiserver endpoint eip
      set_fact:
        kube_apiserver_endpoint_ip: |-
          {% if use_load_balancer -%}
            {{ load_balancer_vip }}
          {%- else -%}
            {{ first_master_eip }}
          {%- endif %}

    # avoid "Device or resource busy" when run in pod
    - name: Update /etc/hosts if uninstalling caicloudstack
      become: yes
      shell: newhosts=`mktemp` && sed -e '/{{ kube_apiserver_endpoint_ip }} {{ dns_host_name }}/d' /etc/hosts > $newhosts && /bin/cp $newhosts /etc/hosts && /bin/rm $newhosts
      when: (dns_host_name is defined) and (dns_host_name == "caicloudstack")
