###
# kubernetes kubelet (node) config

# The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)
KUBELET_ADDRESS="--address={{ hostvars[inventory_hostname]['internal_ip'] }}"

# The port for the info server to serve on
# KUBELET_PORT="--port=10250"

# You may leave this blank to use the actual hostname
KUBELET_HOSTNAME="--hostname-override={{ inventory_hostname }}"

# location of the api-server
# Flag --api-servers has been deprecated on 1.4, Use --kubeconfig instead.
{% if kube_base_version | version_compare('v1.4.0', '>=') %}
KUBELET_API_SERVER=""
{% else %}
KUBELET_API_SERVER="--api-servers={{ kube_apiserver_endpoint }}"
{% endif %}

{% set kubelet_options = [] -%}
{% if dns_setup -%}
{{ kubelet_options.append('--cluster-dns=' + dns_server)|default('', true) -}}
{{ kubelet_options.append('--cluster-domain=' + dns_domain)|default('', true) -}}
{% endif -%}
{% if networking == "opencontrail" -%}
{{ kubelet_options.append('--network-plugin=opencontrail')|default('', true) -}}
{% endif -%}
{% if networking == "weave" or networking == "calico" -%}
{{ kubelet_options.append('--network-plugin=cni')|default('', true) -}}
{% endif -%}
{% if networking == "calico" -%}
{{ kubelet_options.append('--network-plugin-dir=/etc/cni/net.d')|default('', true) -}}
{% endif -%}
{% if host_provider == "aliyun" or host_provider == "anchnet" -%}
{{ kubelet_options.append('--enable-controller-attach-detach=true')|default('', true) -}}
{% endif -%}

# Add your own!
{% if kube_base_version | version_compare('v1.4.0', '>=') %}
KUBELET_ARGS="--require-kubeconfig --kubeconfig={{ kube_config_dir }}/kubelet.kubeconfig --register-schedulable=false --pod-manifest-path={{ kube_manifest_dir }} --pod-infra-container-image={{ pod_infra_container_image }} --node-ip={{ hostvars[inventory_hostname]['internal_ip'] }} {{ kubelet_options|join(' ') }}"
{% else %}
KUBELET_ARGS="--kubeconfig={{ kube_config_dir }}/kubelet.kubeconfig --register-schedulable=false --config={{ kube_manifest_dir }} --pod-infra-container-image={{ pod_infra_container_image }} --node-ip={{ hostvars[inventory_hostname]['internal_ip'] }} {{ kubelet_options|join(' ') }}"
{% endif %}
