#!/bin/sh

DOCKER_OPTS="-H tcp://127.0.0.1:4243 -H unix:///var/run/docker.sock"

# wait for flannel writing env
if [[ ! -f /run/flannel/subnet.env ]]; then
  sleep 5
fi

if [ -f "/run/flannel/subnet.env" ] && \\
  grep -q "FLANNEL_SUBNET" /run/flannel/subnet.env && \\
  grep -q "FLANNEL_MTU" /run/flannel/subnet.env && \\
  grep -q "FLANNEL_IPMASQ" /run/flannel/subnet.env ; then
  . /run/flannel/subnet.env
  if [ "$FLANNEL_IPMASQ" = true ] ; then
    DOCKER_OPT_IPMASQ="--ip-masq=false"
  elif [ "$FLANNEL_IPMASQ" = false ] ; then
    DOCKER_OPT_IPMASQ="--ip-masq=true"
  else
    DOCKER_OPT_IPMASQ=""
    echo "Invalid value of FLANNEL_IPMASQ: $FLANNEL_IPMASQ" > /dev/stderr
  fi
  DOCKER_OPTS="${DOCKER_OPTS} --bip ${FLANNEL_SUBNET} --mtu ${FLANNEL_MTU} ${DOCKER_OPT_IPMASQ}"
fi
