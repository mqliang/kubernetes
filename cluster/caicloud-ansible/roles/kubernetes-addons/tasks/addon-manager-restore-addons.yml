---
# Restore addons for addon-manager.

- name: Restore addons | Wait for available addon-manager-master endpoint
  shell: "{{ bin_dir }}/kubectl get ep addon-manager-master | grep addon-manager-master | awk '{print $2}'"
  register: addon_manager_master_endpoint
  until: addon_manager_master_endpoint|success and addon_manager_master_endpoint.stdout.find('none') == -1
  retries: "{{ 15 * retry_ratio }}"
  delay: 20

- name: Restore addons | Wait for addon-manager-master
  uri: url=http://{{ addon_manager_master_endpoint.stdout }}/version
  register: addon_result
  until: addon_result|success and addon_result.status == 200
  retries: "{{ 15 * retry_ratio }}"
  delay: 20

- name: Restore addons | Get addon-manager-mongo pod name
  shell: "{{ bin_dir }}/kubectl get pods -l caicloud-app=addon-manager-mongo -o go-template=\"{{ '{{' }}range.items{{ '}}' }}{{ '{{' }}.metadata.name{{ '}}' }}{{ '{{' }}end{{ '}}' }}\""
  register: addon_mongo_name_result
  until: addon_mongo_name_result|success
  retries: 3
  delay: 5

- name: Restore addons | Proxy addon-manager-mongo port to localhost
  shell: "{{ bin_dir }}/kubectl port-forward {{ addon_mongo_name_result.stdout }} 27017"
  async: 120
  delegate_to: localhost

- name: Restore addons | Restore addons
  shell: "{{ bin_dir }}/mongorestore {{ addon_manager_dump_path }}"
  register: addon_publish_result
  until: addon_publish_result|success
  retries: 10
  delay: 5
  delegate_to: localhost
