---
# Base kubernetes tasks for all masters/nodes, including:
#  - create various directories (see defaults/main.yml)
#  - write global config file
#  - download and link all kubernetes binaries
#  - generate certs and tokens
#
# Notes about configurations:
# - For upstart, components' configurations are located at /etc/default/$name; which
#   loads its configs from /etc/kubernetes/ directory.
# - For systemd, components' configurations are written directly in unit files, i.e.
#   /etc/systemd/system/$name; which also loads its configs from /etc/kubernetes/.

#
# Set docker container log rotation.

- name: Set docker container log rotation
  include: configure-logging.yml

#
# Disable swap.

- name: Turn off swap
  command: swapoff -a
  failed_when: false

- name: Disable swap permanently
  replace:
    dest: /etc/fstab
    regexp: '(^[^#].*\s+swap\s+.*$)'
    replace: '#\1'

#
# Make sure directories exist.

- name: Create kubernetes config directory
  file: path={{ kube_config_dir }} state=directory

- name: Create kubernetes config temp directory
  file: path={{ kube_config_temp_dir }} state=directory

- name: Create kubernetes script directory
  file: path={{ kube_script_dir }} state=directory

- name: Create kubernetes manifest directory
  file: path={{ kube_manifest_dir }} state=directory

- name: Create binary directory
  file: path={{ bin_dir }} state=directory

- name: Create the kubelet working directory
  file: path={{ kubelet_working_dir }} state=directory

# Install expect and rsync.
- name: Install expect and rsync
  package: name={{ item }} state=present
  with_items:
    - "expect"
    - "rsync"

#
# Misc preparations for bringing up cluster.

- name: Copy cloud-config to {{ kube_config_dir }}
  copy: src={{ cloud_config_dir }}/cloud-config dest={{ kube_config_dir }}/cloud-config
  when: host_provider == "aliyun" or host_provider == "anchnet"

- name: Write the global config file for all components
  template: src=config.j2 dest={{ kube_config_dir }}/config
  notify:
    - restart daemons

- name: Download and extract tar file from qiniu for all hosts
  include: qiniu.yml

- name: Generate certs (or use ca-signed certs) and tokens
  include: secrets.yml

- name: Send docker config.json to all instances to pull image
  copy: src=docker-config.json dest={{ kubelet_working_dir }}/config.json
