# Caicloud kubernetes

## Overview

Caicloud kubernetes is a customized kubernetes hosted by [caicloud.io](https://caicloud.io). Currently, we support [Anchnet](http://cloud.51idc.com/),
and there is plan to add more cloudproviders. Kubernetes is the building block of caicloud.io, the long term plan is to enrich its ecosystem to enable
enterprise use cases.

## How to do a release

To build release, use `./build-tarball.sh`. The script will build caicloud kubernetes binaries (kubelet, apiserver, etc) and scripts release
(kube-up.sh, kube-down.sh etc). To see its full description, run:
```
./build-tarball.sh help
```

E.g. following command will build tarballs tagged with version v1.0.1, and push to tool server (push to tool server is the default behavior):
```
./build-tarball.sh v1.0.1
```

If running without param, the script will build images with current date/time, this is useful during development. E.g. following command
will build images tagged with something like image:2015-09-10-18-15-30.
```
./build-tarball.sh
```

## Maintenance

A couple points related to how to maintain caicloud kubernetes.

### Rebase to latest public mainstream
* Find the commit to rebase
* Checkout to caicloud master branch
* git rebase --preserve-merges -i $COMMIT_ID
* git push private-upstream master -f

(Use `git config --global rerere.enabled true` to reuse recorded resolustion)

### Changes relative to public mainstream
#### New folders:
These are brand new folders created to support our cloudprovider:
* hack/caicloud
  * Central information about caicloud kubernetes
  * Tools for working with caicloud kubernetes
* cluster/anchnet
  * Shell scripts used to bring up cluster in anchnet
* examples/caicloud
  * Examples for caicloud, typically about how to use caicloud supported cloudproviders
* pkg/cloudprovider/providers/anchnet
  * Go package used for cloudprovider plugin
* pkg/volume/anchnet_pd
  * Go package used for anchnet persistent volume plugin

#### Changes to individual files
These are individual files we have to change in order to meet our requirements:
* cluster/kube-up.sh
  * To call deploy-addons, should go away if we deploy addons reliably
* cmd/kubelet/app/plugins.go
  * To load anchnet volume plugin
* test/e2e/util.go
  * To use correct ssh private key & user for e2e test
* pkg/api/types.go, pkg/api/v1/types.go
  * To add `AnchnetPersistentDisk` field in `VolumeSource` structure
  * To add `AnchnetPersistendDisk` field in `PersistentVolumeSource` structure
* pkg/api/validation/validation.go
  * To support validate anchnet persistent disk
* pkg/api/deep_copy_generated.go, pkg/api/v1/conversion_generated.go, pkg/api/v1/deep_copy_generated.go, pkg/expapi/deep_copy_generated.go, pkg/expapi/v1/conversion_generated.go, pkg/expapi/v1/deep_copy_generated.go
  * To support API type changes
  * Auto generated by hack/update-genereated-deep-copies.sh and hack/update-generated-conversions.sh

#### Depedencies:
Add more dependencies in godeps:
* Anchnet-go: SDK for anchnet API

### Things need to be updated after rebasing
* Merge conflict from above changes (we try to keep this as minimal as possible)
* In `hack/caicloud/`, we have scripts fixing GFW issues, make sure it still works with newer kubernetes version
* Run `hack/caicloud/sync-images.sh` to sync all gcr.io images
* Run `hack/caicloud/caicloud-e2e-test.sh`, `hack/build-go.sh`, `hack/test-go.sh`, `hack/test-integration.sh` to build/test new version
